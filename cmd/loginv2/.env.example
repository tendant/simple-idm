# Simple IDM LoginV2 Server Configuration
# Copy this file to .env and update the values for your environment

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

# Base URL for the application
BASE_URL=http://localhost:4000

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

# PostgreSQL Database Connection
IDM_PG_HOST=localhost
IDM_PG_PORT=5432
IDM_PG_DATABASE=idm_db
IDM_PG_USER=idm
IDM_PG_PASSWORD=your_password_here
IDM_PG_SCHEMA=public

# =============================================================================
# JWT CONFIGURATION
# =============================================================================

# JWT Secret Key (use a strong, random secret in production)
JWT_SECRET=very-secure-jwt-secret

# JWT Token Settings
JWT_ISSUER=simple-idm
JWT_AUDIENCE=simple-idm

# Cookie Settings
COOKIE_HTTP_ONLY=true
COOKIE_SECURE=true

# Token Expiry Durations (ISO 8601 duration format)
ACCESS_TOKEN_EXPIRY=5m
REFRESH_TOKEN_EXPIRY=15m
TEMP_TOKEN_EXPIRY=10m
LOGOUT_TOKEN_EXPIRY=-1m

# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================

# SMTP Server Settings
EMAIL_HOST=localhost
EMAIL_PORT=1025
EMAIL_USERNAME=noreply@example.com
EMAIL_PASSWORD=your_email_password
EMAIL_FROM=noreply@example.com
EMAIL_TLS=false

# =============================================================================
# TWILIO CONFIGURATION (SMS)
# =============================================================================

# Twilio SMS Settings (optional)
# TWILIO_ACCOUNT_SID=your_twilio_account_sid
# TWILIO_AUTH_TOKEN=your_twilio_auth_token
# TWILIO_FROM=+1234567890

# =============================================================================
# PASSWORD POLICY CONFIGURATION
# =============================================================================

# Enable password policy validation
# Set to false for development to accept any password (convenient for testing)
# Default: true (enabled for production)
PASSWORD_POLICY_ENABLED=true

# Basic Password Requirements (when enabled)
PASSWORD_COMPLEXITY_REQUIRED_LENGTH=8
PASSWORD_COMPLEXITY_REQUIRE_DIGIT=true
PASSWORD_COMPLEXITY_REQUIRE_LOWERCASE=true
PASSWORD_COMPLEXITY_REQUIRE_NON_ALPHANUMERIC=true
PASSWORD_COMPLEXITY_REQUIRE_UPPERCASE=true

# Optional Security Features (when enabled)
PASSWORD_COMPLEXITY_DISALLOW_COMMON_PWDS=true     # Check against 10 common passwords
PASSWORD_COMPLEXITY_MAX_REPEATED_CHARS=3          # Max consecutive repeated chars (0=disabled)

# Enterprise Features (typically disabled, enable for compliance)
PASSWORD_COMPLEXITY_HISTORY_CHECK_COUNT=0         # Prevent password reuse (0=disabled, try 5)
PASSWORD_COMPLEXITY_EXPIRATION_PERIOD=P100Y       # Password expiration (P100Y=100 yearsâ‰ˆdisabled, try P90D for 90 days)
PASSWORD_COMPLEXITY_MIN_PASSWORD_AGE_PERIOD=PT0M  # Min time between changes (PT0M=disabled, try PT24H for 24 hours)

# =============================================================================
# LOGIN CONFIGURATION
# =============================================================================

# Login Security Settings
LOGIN_MAX_FAILED_ATTEMPTS=10000
LOGIN_LOCKOUT_DURATION=PT0M
DEVICE_EXPIRATION_DAYS=P90D

# Registration Settings
LOGIN_REGISTRATION_ENABLED=false
LOGIN_REGISTRATION_DEFAULT_ROLE=readonlyuser

# Magic Link Settings
MAGIC_LINK_TOKEN_EXPIRATION=PT6H

# Phone Verification
PHONE_VERIFICATION_SECRET=secret

# =============================================================================
# OAUTH2 CLIENT CONFIGURATION
# =============================================================================

# OAuth2 Client Secret Encryption Key (32 bytes base64 encoded)
# Generate with: openssl rand -base64 32
OAUTH2_CLIENT_ENCRYPTION_KEY=your_base64_encoded_32_byte_key_here

# =============================================================================
# JWKS CONFIGURATION
# =============================================================================

# JWKS Key ID (unique identifier for the key)
JWKS_KEY_ID=your_unique_key_id_here

# JWKS Algorithm (typically RS256)
JWKS_ALGORITHM=RS256

# Path to RSA Private Key PEM file
# Generate with: openssl genrsa -out jwt-private.pem 2048
JWKS_PRIVATE_KEY_FILE=jwt-private.pem

# =============================================================================
# EXTERNAL PROVIDER CONFIGURATION (OAuth2/OIDC)
# =============================================================================

# Default role for users created via external providers
EXTERNAL_PROVIDER_DEFAULT_ROLE=user

# Google OAuth2
GOOGLE_ENABLED=false
# GOOGLE_CLIENT_ID=your_google_client_id
# GOOGLE_CLIENT_SECRET=your_google_client_secret

# Microsoft OAuth2
MICROSOFT_ENABLED=false
# MICROSOFT_CLIENT_ID=your_microsoft_client_id
# MICROSOFT_CLIENT_SECRET=your_microsoft_client_secret

# GitHub OAuth2
GITHUB_ENABLED=false
# GITHUB_CLIENT_ID=your_github_client_id
# GITHUB_CLIENT_SECRET=your_github_client_secret

# LinkedIn OAuth2
LINKEDIN_ENABLED=false
# LINKEDIN_CLIENT_ID=your_linkedin_client_id
# LINKEDIN_CLIENT_SECRET=your_linkedin_client_secret

# =============================================================================
# API ENDPOINT PREFIX CONFIGURATION
# =============================================================================

# Configure custom API endpoint prefixes for flexible API gateway routing
# By default, uses v1 prefix pattern: /api/v1/idm/* for IDM endpoints
#
# Configuration priority (highest to lowest):
# 1. API_PREFIX_BASE - Set one prefix for all routes (simplest, recommended)
# 2. API_PREFIX_LEGACY - Use legacy pattern for backward compatibility
# 3. Individual API_PREFIX_* overrides - Override specific routes
# 4. Default v1 prefixes - /api/v1/idm/* pattern

# Simple configuration: Set one prefix for all endpoints (RECOMMENDED)
# API_PREFIX_BASE=/api/v1/idm
# All routes automatically: /api/v1/idm/auth, /api/v1/idm/signup, etc.

# Legacy mode (for backward compatibility with pre-v2.0.0 deployments)
# API_PREFIX_LEGACY=false

# Advanced: Override individual endpoint prefixes (after applying base or defaults)
# API_PREFIX_AUTH=/api/v1/idm/auth
# API_PREFIX_SIGNUP=/api/v1/idm/signup
# API_PREFIX_PROFILE=/api/v1/idm/profile
# API_PREFIX_2FA=/api/v1/idm/2fa
# API_PREFIX_EMAIL=/api/v1/idm/email
# API_PREFIX_PASSWORD_RESET=/api/v1/idm/password-reset
# API_PREFIX_OAUTH2=/api/v1/oauth2
# API_PREFIX_USERS=/api/v1/idm/users
# API_PREFIX_ROLES=/api/v1/idm/roles
# API_PREFIX_DEVICE=/api/v1/idm/device
# API_PREFIX_LOGINS=/api/v1/idm/logins
# API_PREFIX_OAUTH2_CLIENTS=/api/v1/idm/oauth2-clients
# API_PREFIX_EXTERNAL=/api/v1/idm/external

# Example: API Gateway with base prefix and selective overrides
# API_PREFIX_BASE=/api/v1/idm
# API_PREFIX_2FA=/security-service/2fa  # Route just 2FA to different service

# =============================================================================
# RATE LIMITING CONFIGURATION
# =============================================================================

# Rate limiting helps protect your API from abuse, brute force attacks, and DoS attempts.
# All rates are specified as requests per second (refill rate) with a burst capacity.

# Global Rate Limiting (applies to all requests)
RATELIMIT_GLOBAL_ENABLED=true
RATELIMIT_GLOBAL_CAPACITY=1000              # Burst capacity
RATELIMIT_GLOBAL_REFILL_RATE=16.67          # ~1000 requests per minute

# Per-IP Rate Limiting (prevents abuse from single IP)
RATELIMIT_PER_IP_ENABLED=true
RATELIMIT_PER_IP_CAPACITY=100               # Burst capacity per IP
RATELIMIT_PER_IP_REFILL_RATE=1.67           # ~100 requests per minute per IP

# Per-User Rate Limiting (for authenticated requests)
RATELIMIT_PER_USER_ENABLED=true
RATELIMIT_PER_USER_CAPACITY=200             # Burst capacity per user
RATELIMIT_PER_USER_REFILL_RATE=3.33         # ~200 requests per minute per user

# Login Endpoint Rate Limiting (prevents brute force attacks)
RATELIMIT_LOGIN_ENABLED=true
RATELIMIT_LOGIN_CAPACITY=10                 # 10 login attempts burst
RATELIMIT_LOGIN_REFILL_RATE=0.167           # 10 attempts per minute per IP

# Signup Endpoint Rate Limiting (prevents spam registrations)
RATELIMIT_SIGNUP_ENABLED=true
RATELIMIT_SIGNUP_CAPACITY=5                 # 5 signup attempts burst
RATELIMIT_SIGNUP_REFILL_RATE=0.017          # 5 attempts per 5 minutes per IP

# Password Reset Rate Limiting (prevents enumeration and spam)
RATELIMIT_PASSWORD_RESET_ENABLED=true
RATELIMIT_PASSWORD_RESET_CAPACITY=3         # 3 reset requests burst
RATELIMIT_PASSWORD_RESET_REFILL_RATE=0.00083 # 3 requests per hour per IP

# Rate Limit Headers (include rate limit info in responses)
RATELIMIT_INCLUDE_HEADERS=true              # Add X-RateLimit-* headers

# Rate Limiting Notes:
# - Refill rate is in requests per second (e.g., 16.67 = 1000/60 = ~1000 per minute)
# - Capacity is the burst allowance (allows brief traffic spikes)
# - Login limits are per-IP to prevent distributed brute force
# - Password reset limits are strict to prevent enumeration attacks
# - Set ENABLED=false to disable specific limiters
# - Authenticated users get higher limits than IPs (per-user > per-IP)
# - Rate limiting uses token bucket algorithm for smooth rate limiting
# - When rate limit is exceeded, HTTP 429 (Too Many Requests) is returned

# =============================================================================
# NOTES
# =============================================================================

# Configuration Priority (highest to lowest):
# 1. Environment variables
# 2. .env file values
# 3. Built-in defaults

# Duration Format:
# - Use ISO 8601 duration format (e.g., PT5M for 5 minutes, P90D for 90 days)
# - PT prefix for time durations, P prefix for date durations

# Security Notes:
# - Change JWT_SECRET to a strong, random value in production
# - Set COOKIE_SECURE=true when using HTTPS
# - Keep sensitive values like client secrets secure
# - This .env file should be added to .gitignore

# External Provider Setup:
# - Set *_ENABLED=true to enable each provider
# - Obtain client credentials from respective provider consoles
# - Configure redirect URIs in provider settings to match your BASE_URL
